#ifndef SCENE_H
#define SCENE_H

#include <SDL2/SDL.h>
#include <string>
#include <glm/glm.hpp>
#include "Emitter.h"
#include "ImGUIImpl.h"

//------------------------------------------------------------------------------------------------------------------------
/// \file Scene.h
/// \author Jack Diver
/// \version 5.2
/// \date Last Revision 03/05/17 Updated to NCCA coding standard \n

/// Revision History: \n
/// 03/05/17 Fixed crash when double clicking on colour selector window header \n
/// 03/05/17 Implemented GUI tabs \n
/// 01/05/17 Added screenshot feature \n
/// 30/04/17 Experimenting with threads, and improved GUI with more functionality \n
/// 24/04/17 Fixed texture bug, gui now functional \n
/// 23/04/17 Successfully implemented ImGui, TODO: Fix GUI texture bug \n
/// 18/04/17 Implemented point attenuation, points now scale with distance \n
/// 17/04/17 Used new implementation of scene rotation to fix gimbal lock issues \n
/// 15/04/17 Fixed SDL event queue spamming by replacing if statement with while loop \n
/// 08/04/17 Implemented scene navigation, TODO: fix gimbal locking \n
/// 08/04/17 Added grid to scene for easier navigation \n
/// 28/03/17 Added point sprite texturing and changed blend function to additive \n
/// 23/03/17 Refactored header files \n
/// Initial Version 20/03/17

/// \class Scene
/// \brief encapsulates a 3D OpenGL Scene
/// \todo extend GUI functionality
//------------------------------------------------------------------------------------------------------------------------

class Scene
{
public:
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Flag to close the window
  //----------------------------------------------------------------------------------------------------------------------
  bool m_quit = false;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Holds the current user input
  //----------------------------------------------------------------------------------------------------------------------
  SDL_Event m_inputEvent;

public :
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Default constructor that initialises member variables to default values
  //----------------------------------------------------------------------------------------------------------------------
  Scene() = default;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Constructor that takes a name, intial size and intial position to generate an SDL window,
  /// with an OpenGL context
  /// @param[in] _name the name of the window
  /// @param[in] _x the intial x position of the window
  /// @param[in] _y the intial y position of the window
  /// @param[in] _width the intial width of the window
  /// @param[in] _height the intial height of the window
  //----------------------------------------------------------------------------------------------------------------------
  Scene(std::string const&_name, int const&_x, int const&_y, int const&_width, int const&_height);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Default destructor
  //----------------------------------------------------------------------------------------------------------------------
  ~Scene();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Calls SDL_GL_MakeCurrent to link our SDL_Window and OpenGL context
  //----------------------------------------------------------------------------------------------------------------------
  inline void makeCurrent() const { SDL_GL_MakeCurrent(m_sdlWin,m_glContext);}
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws the GUI, particles and the window
  //----------------------------------------------------------------------------------------------------------------------
  void draw();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Increments the frame count by one and updates the particle system,
  /// also takes user input
  //----------------------------------------------------------------------------------------------------------------------
  void tick();

private :
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Flage to update the particle system
  //----------------------------------------------------------------------------------------------------------------------
  bool m_pause = false;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Flag to take a screen shot and save as a .png image
  //----------------------------------------------------------------------------------------------------------------------
  bool m_snap = false;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Flag to draw grid
  //----------------------------------------------------------------------------------------------------------------------
  bool m_grid = true;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Holds the ImGui inputs
  //----------------------------------------------------------------------------------------------------------------------
  ImGuiIO &m_io = ImGui::GetIO();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Stores a reference to the ImGui style
  //----------------------------------------------------------------------------------------------------------------------
  ImGuiStyle &m_style = ImGui::GetStyle();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Current GUI tab
  //----------------------------------------------------------------------------------------------------------------------
  int m_tab = 0;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Width of the window
  //----------------------------------------------------------------------------------------------------------------------
  int m_width = 640;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Height of the window
  //----------------------------------------------------------------------------------------------------------------------
  int m_height = 480;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Window position
  //----------------------------------------------------------------------------------------------------------------------
  glm::ivec2 m_winPos = glm::ivec2(0.0f,0.0f);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Stores the mouse co-ordinates
  //----------------------------------------------------------------------------------------------------------------------
  glm::ivec2 m_mousePos;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Stores the translation of the opengl view
  //----------------------------------------------------------------------------------------------------------------------
  glm::vec3 m_translation = glm::vec3(0.0f,-30.0f,150.0f);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Stores the rotation of the opengl view
  //----------------------------------------------------------------------------------------------------------------------
  glm::vec2 m_rotation = glm::vec2(0.0f,0.0f);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Name of the window
  //----------------------------------------------------------------------------------------------------------------------
  std::string m_name = "Default";
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief The SDL Window
  //----------------------------------------------------------------------------------------------------------------------
  SDL_Window *m_sdlWin = NULL;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief The particle Emitter
  //----------------------------------------------------------------------------------------------------------------------
  Emitter m_emit;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Stores the opengl context
  //----------------------------------------------------------------------------------------------------------------------
  SDL_GLContext m_glContext;

private:
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Initialises SDL and calls other initialisation functions
  //----------------------------------------------------------------------------------------------------------------------
  void init();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Initialises OpenGL to draw textured, point sprites with attenuation
  //----------------------------------------------------------------------------------------------------------------------
  void initGL() const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Creates an OpenGL contex and links to our SDL window
  //----------------------------------------------------------------------------------------------------------------------
  void createGLContext();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Loads a projection matrix into OpenGL
  //----------------------------------------------------------------------------------------------------------------------
  void loadProjection(const glm::mat4 &_matrix) const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Loads a model view matrix into OpenGL
  //----------------------------------------------------------------------------------------------------------------------
  void loadModelView(glm::mat4 const&_matrix) const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Prints the provided string, and error caught by SDL, then exits
  //----------------------------------------------------------------------------------------------------------------------
  void ErrorExit(std::string const&_msg) const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws a grid
  //----------------------------------------------------------------------------------------------------------------------
  void drawGrid(int const&_num, int const&_step) const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Resets the OpenGL view to our default settings
  //----------------------------------------------------------------------------------------------------------------------
  void resetPos();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Converts mouse events to scene navigation
  //----------------------------------------------------------------------------------------------------------------------
  void handleMouse();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Resizes the OpenGL viewport, then loads a new projection based on window dimensions
  //----------------------------------------------------------------------------------------------------------------------
  void resize() const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Reads the OpenGL pixel data and saves a .png file in /screenshots folder
  //----------------------------------------------------------------------------------------------------------------------
  void takeScreencap() const;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Sets the style of the ImGui interface
  //----------------------------------------------------------------------------------------------------------------------
  void initStyle();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws all ImGui elements
  //----------------------------------------------------------------------------------------------------------------------
  void displayGui();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws the flame GUI
  //----------------------------------------------------------------------------------------------------------------------
  void displayFlameGui();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws the explosion GUI
  //----------------------------------------------------------------------------------------------------------------------
  void displayExplosionGui();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws the firework GUI
  //----------------------------------------------------------------------------------------------------------------------
  void displayFireworkGui();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Draws the system information GUI
  //----------------------------------------------------------------------------------------------------------------------
  void displaySystemGui();

}; // class end

#endif // SCENE_H
